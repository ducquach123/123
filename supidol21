repeat task.wait() until game:IsLoaded()
task.wait(2)

-- 🎯 Danh sách target (LocalizedText)
local targets = {
    "Strawberry Elephant","Graipuss Medussi","To to to Sahur","Pot Hotspot","Chicleteira Bicicleteira",
    "Los Chicleteiras","La Grande Combinasion","Nuclearo Dinossauro","Esok Sekolah","Ketupat Kepat",
    "Money Money Puggy","Tictac Sahur","Ketchuru and Musturu","Garama and Madundung","Spaghetti Tualetti",
    "Dragon Cannelloni","67","Mariachi Corazoni","Tacorita Bicicleta","La Extinct Grande",
    "Quesadilla Crocodila","Los Nooo My Hotspotsitos","Las Sis","Celularcini Viciosini","Los Bros",
    "Tralaledon","Los Tacoritas","Los Primos","La Sahur Combinasion","Los Combinasionas",
    "Los Hotspotsitos","La Supreme Combinasion","Los 67","La Secret Combinasion","Burguro And Fryuro"
}

-- 🌐 Webhook
local HttpService = game:GetService("HttpService")
local url = "https://discord.com/api/webhooks/1422467802744356955/MtviPDZEJ2mnRUkErjusdNheW3exDBVGPCg-1AXvmHjnai17llKqA1NMTeKwetjSp05k"

-- 📜 Join Script + Link
local function getJoinScript()
    return 'game:GetService("TeleportService"):TeleportToPlaceInstance(' .. game.PlaceId .. ', "' .. game.JobId .. '", game.Players.LocalPlayer)'
end

local function getJoinLink()
    return "https://chillihub1.github.io/chillihub-joiner/?placeId=" .. game.PlaceId .. "&gameInstanceId=" .. game.JobId
end

-- 🔍 Check target
local function checkTargets()
    local foundTargets = {}
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("TextLabel") and obj.Name == "DisplayName" then
            local txt = string.lower(obj.LocalizedText or "")
            for _, name in ipairs(targets) do
                if string.find(txt, string.lower(name)) then
                    if not table.find(foundTargets, name) then
                        table.insert(foundTargets, name)
                    end
                end
            end
        end
    end
    return #foundTargets > 0, foundTargets
end

-- 📤 Gửi webhook
local function sendWebhook(foundTargets)
    local Players = game:GetService("Players")
    local payload = {
        ["embeds"] = { {
            ["title"] = "🎯 Target Detected!",
            ["description"] = "✅ " .. table.concat(foundTargets, ", "),
            ["color"] = 0x00FF00,
            ["fields"] = {
                {["name"] = "👥 Players", ["value"] = tostring(#Players:GetPlayers()) .. " / " .. tostring(Players.MaxPlayers), ["inline"] = true},
                {["name"] = "🆔 JobId", ["value"] = "`" .. game.JobId .. "`", ["inline"] = true},
                {["name"] = "🌐 Join Link", ["value"] = "[Click to Join](" .. getJoinLink() .. ")", ["inline"] = false},
                {["name"] = "📜 Join Script", ["value"] = "```lua\n" .. getJoinScript() .. "\n```", ["inline"] = false},
                {["name"] = "🎮 Game", ["value"] = "**" .. game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name .. "**", ["inline"] = false}
            },
            ["footer"] = {["text"] = "Spyder Scanner | User: " .. game.Players.LocalPlayer.Name},
            ["timestamp"] = DateTime.now():ToIsoDate()
        }},
        ["username"] = "Spyder Scanner"
    }

    pcall(function()
        http_request({
            Url = url,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(payload)
        })
    end)
    print("✅ Đã gửi webhook:", table.concat(foundTargets, ", "))
end

-- 🚪 Server hop
pcall(function()
    local TeleportService = game:GetService("TeleportService")
    local Players = game:GetService("Players")

    local PlaceID = game.PlaceId
    local foundAnything = ""
    local AllIDs = {}

    -- 📂 File chung
    local fileName = "AllServers.json"

    -- Đọc file
    local success, result = pcall(function()
        return HttpService:JSONDecode(readfile(fileName))
    end)
    if success and type(result) == "table" then
        AllIDs = result
    else
        AllIDs = {}
        pcall(function()
            writefile(fileName, HttpService:JSONEncode(AllIDs))
        end)
    end

    -- Lưu JobId mới (tối đa 10)
    local function saveJobId(id)
        if not table.find(AllIDs, id) then
            table.insert(AllIDs, id)
            if #AllIDs > 10 then
                table.remove(AllIDs, 1)
            end
            pcall(function()
                writefile(fileName, HttpService:JSONEncode(AllIDs))
            end)
        end
    end

    -- Lấy danh sách server
    local function ListServers(cursor)
        task.wait(math.random(2,9))
        local url = "https://games.roblox.com/v1/games/" .. PlaceID .. "/servers/Public?sortOrder=Asc&limit=100"
        if cursor then url = url .. "&cursor=" .. cursor end
        local ok, body = pcall(function() return game:HttpGet(url) end)
        if ok and body then
            local decoded = HttpService:JSONDecode(body)
            if decoded and decoded.data then return decoded end
        end
        return {data={}}
    end

    -- Teleport
    local function TPReturner()
        -- 🔍 check target 1 lần đầu
        local found, foundTargets = checkTargets()
        if found then
            print("🔍 Target phát hiện, chờ 4s để xác nhận...")
            task.wait(4)
            local stillFound, stillTargets = checkTargets()
            if stillFound then
                sendWebhook(stillTargets)
                print("🎯 Xác nhận còn target sau 4s → gửi webhook!")
            else
                print("❌ Target biến mất sau 4s → bỏ qua, hop tiếp.")
            end
        end

        -- 📜 Server hop
        local servers = ListServers(foundAnything)
        if servers.nextPageCursor then
            foundAnything = servers.nextPageCursor
        end

        for _, v in ipairs(servers.data) do
            local id = tostring(v.id)
            if v.playing < v.maxPlayers and id ~= game.JobId then
                if not table.find(AllIDs, id) then
                    saveJobId(id)
                    print("🔄 Teleporting tới server:", id, " | " .. v.playing .. "/" .. v.maxPlayers)
                    TeleportService:TeleportToPlaceInstance(PlaceID, id, Players.LocalPlayer)
                    task.wait(0.5)
                end
            end
        end
    end

    -- 🔁 vòng lặp server hop
    while task.wait(0.75) do
        pcall(TPReturner)
    end
end)
